name: Cleanup PR Environment

on:
  pull_request:
    types: [closed, unlabeled]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PRç•ªå·ã‚’æŒ‡å®šã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—'
        required: true
        type: string
      force_cleanup:
        description: 'å¼·åˆ¶å‰Šé™¤ãƒ•ãƒ©ã‚°'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write
  pull-requests: write

env:
  REGION: asia-northeast1
  BASE_SERVICE: x-fact-checker

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set PR number
      id: set-pr
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          echo "is_manual=true" >> $GITHUB_OUTPUT
        else
          echo "pr_number=${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "is_manual=false" >> $GITHUB_OUTPUT
        fi

    - name: Check cleanup conditions
      id: check-conditions
      run: |
        # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯å¸¸ã«å®Ÿè¡Œ
        if [ "${{ steps.set-pr.outputs.is_manual }}" = "true" ]; then
          echo "should_cleanup=true" >> $GITHUB_OUTPUT
          echo "reason=manual_trigger" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # PRã‚¯ãƒ­ãƒ¼ã‚ºã®å ´åˆ
        if [ "${{ github.event.action }}" = "closed" ]; then
          echo "should_cleanup=true" >> $GITHUB_OUTPUT
          echo "reason=pr_closed" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # ãƒ©ãƒ™ãƒ«å‰Šé™¤ã®å ´åˆ
        if [ "${{ github.event.action }}" = "unlabeled" ]; then
          if echo "${{ github.event.label.name }}" | grep -q "deploy-dev"; then
            echo "should_cleanup=true" >> $GITHUB_OUTPUT
            echo "reason=label_removed" >> $GITHUB_OUTPUT
          else
            echo "should_cleanup=false" >> $GITHUB_OUTPUT
            echo "reason=irrelevant_label" >> $GITHUB_OUTPUT
          fi
          exit 0
        fi
        
        echo "should_cleanup=false" >> $GITHUB_OUTPUT
        echo "reason=no_conditions_met" >> $GITHUB_OUTPUT

    - name: Skip if conditions not met
      if: steps.check-conditions.outputs.should_cleanup == 'false'
      run: |
        echo "âš ï¸ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“"
        echo "ç†ç”±: ${{ steps.check-conditions.outputs.reason }}"
        echo "PRç•ªå·: ${{ steps.set-pr.outputs.pr_number }}"
        exit 0

    - name: Check if running on fork
      if: steps.check-conditions.outputs.should_cleanup == 'true'
      id: fork-check
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
          echo "is_fork=true" >> $GITHUB_OUTPUT
          echo "::warning::ãƒ•ã‚©ãƒ¼ã‚¯ã‹ã‚‰ã®PRã®ãŸã‚ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
        else
          echo "is_fork=false" >> $GITHUB_OUTPUT
        fi

    - name: Authenticate to Google Cloud
      if: steps.check-conditions.outputs.should_cleanup == 'true' && steps.fork-check.outputs.is_fork == 'false'
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}
        project_id: ${{ secrets.PROJECT_ID }}

    - name: Setup gcloud
      if: steps.check-conditions.outputs.should_cleanup == 'true' && steps.fork-check.outputs.is_fork == 'false'
      uses: google-github-actions/setup-gcloud@v2

    - name: Set service name
      if: steps.check-conditions.outputs.should_cleanup == 'true' && steps.fork-check.outputs.is_fork == 'false'
      run: |
        echo "SERVICE_NAME=${BASE_SERVICE}-pr-${{ steps.set-pr.outputs.pr_number }}" >> $GITHUB_ENV

    - name: Check if service exists
      if: steps.check-conditions.outputs.should_cleanup == 'true' && steps.fork-check.outputs.is_fork == 'false'
      id: check-service
      run: |
        if gcloud run services describe "$SERVICE_NAME" --region="$REGION" --quiet 2>/dev/null; then
          echo "service_exists=true" >> $GITHUB_OUTPUT
          echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹ $SERVICE_NAME ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        else
          echo "service_exists=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ ã‚µãƒ¼ãƒ“ã‚¹ $SERVICE_NAME ã¯å­˜åœ¨ã—ã¾ã›ã‚“"
        fi

    - name: Get service details before deletion
      if: steps.check-conditions.outputs.should_cleanup == 'true' && steps.check-service.outputs.service_exists == 'true' && steps.fork-check.outputs.is_fork == 'false'
      id: service-details
      run: |
        URL=$(gcloud run services describe "$SERVICE_NAME" --region="$REGION" --format="value(status.url)" 2>/dev/null || echo "N/A")
        CREATED=$(gcloud run services describe "$SERVICE_NAME" --region="$REGION" --format="value(metadata.creationTimestamp)" 2>/dev/null || echo "N/A")
        echo "service_url=$URL" >> $GITHUB_OUTPUT
        echo "created_at=$CREATED" >> $GITHUB_OUTPUT

    - name: Delete Cloud Run service
      if: steps.check-conditions.outputs.should_cleanup == 'true' && steps.check-service.outputs.service_exists == 'true' && steps.fork-check.outputs.is_fork == 'false'
      run: |
        echo "ðŸ—‘ï¸ ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤ã‚’é–‹å§‹: $SERVICE_NAME"
        gcloud run services delete "$SERVICE_NAME" --region="$REGION" --quiet
        echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤å®Œäº†: $SERVICE_NAME"

    - name: Delete Artifact Registry repository
      if: steps.check-conditions.outputs.should_cleanup == 'true' && steps.fork-check.outputs.is_fork == 'false'
      continue-on-error: true
      run: |
        echo "ðŸ§¹ Artifact Registryãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’é–‹å§‹"
        
        # PRå°‚ç”¨ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’å®Œå…¨å‰Šé™¤
        if gcloud artifacts repositories describe "$SERVICE_NAME" --location="$REGION" --quiet 2>/dev/null; then
          echo "ãƒªãƒã‚¸ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $SERVICE_NAME"
          echo "ðŸ—‘ï¸ ãƒªãƒã‚¸ãƒˆãƒªå‰Šé™¤ã‚’é–‹å§‹: $SERVICE_NAME"
          gcloud artifacts repositories delete "$SERVICE_NAME" --location="$REGION" --quiet
          echo "âœ… ãƒªãƒã‚¸ãƒˆãƒªå‰Šé™¤å®Œäº†: $SERVICE_NAME"
        else
          echo "âš ï¸ ãƒªãƒã‚¸ãƒˆãƒª $SERVICE_NAME ã¯å­˜åœ¨ã—ã¾ã›ã‚“"
        fi

    - name: Comment on PR (auto cleanup)
      if: steps.check-conditions.outputs.should_cleanup == 'true' && steps.check-conditions.outputs.reason != 'manual_trigger' && github.event_name != 'workflow_dispatch' && steps.fork-check.outputs.is_fork == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const serviceExists = '${{ steps.check-service.outputs.service_exists }}' === 'true';
          const reason = '${{ steps.check-conditions.outputs.reason }}';
          const serviceName = '${{ env.SERVICE_NAME }}';
          const serviceUrl = '${{ steps.service-details.outputs.service_url }}';
          const createdAt = '${{ steps.service-details.outputs.created_at }}';
          
          let body = `ðŸ§¹ **PRé–‹ç™ºç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†**\n\n`;
          
          if (serviceExists) {
            body += `âœ… ã‚µãƒ¼ãƒ“ã‚¹ \`${serviceName}\` ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚\n\n`;
            body += `**å‰Šé™¤ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±:**\n`;
            body += `- URL: ${serviceUrl}\n`;
            body += `- ä½œæˆæ—¥æ™‚: ${createdAt}\n`;
            body += `- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ${{ env.REGION }}\n\n`;
          } else {
            body += `âš ï¸ ã‚µãƒ¼ãƒ“ã‚¹ \`${serviceName}\` ã¯æ—¢ã«å‰Šé™¤æ¸ˆã¿ã¾ãŸã¯å­˜åœ¨ã—ã¾ã›ã‚“ã§ã—ãŸã€‚\n\n`;
          }
          
          if (reason === 'pr_closed') {
            body += `**ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç†ç”±:** PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸ\n`;
          } else if (reason === 'label_removed') {
            body += `**ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç†ç”±:** \`deploy-dev\` ãƒ©ãƒ™ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ\n`;
          }
          
          body += `\n> â„¹ï¸ æœ¬ç•ªç’°å¢ƒã¯å½±éŸ¿ã‚’å—ã‘ã¾ã›ã‚“ã€‚`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Comment on fork PR (skipped cleanup)
      if: steps.check-conditions.outputs.should_cleanup == 'true' && steps.fork-check.outputs.is_fork == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `âš ï¸ **ãƒ•ã‚©ãƒ¼ã‚¯ã‹ã‚‰ã®PRã®ãŸã‚ã€é–‹ç™ºç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ**
            
            ãƒ•ã‚©ãƒ¼ã‚¯ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®PRã§ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ãŸã‚ã€
            Google Cloud ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚
            
            > â„¹ï¸ ãƒ•ã‚©ãƒ¼ã‚¯PRç”¨ã®ç’°å¢ƒã¯å­˜åœ¨ã—ãªã„ãŸã‚ã€ã“ã‚Œã¯æ­£å¸¸ãªå‹•ä½œã§ã™ã€‚`
          });

    - name: Summary output
      if: always()
      run: |
        echo "## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **PRç•ªå·**: ${{ steps.set-pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚µãƒ¼ãƒ“ã‚¹å**: ${{ env.SERVICE_NAME || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œç†ç”±**: ${{ steps.check-conditions.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ**: ${{ steps.check-conditions.outputs.should_cleanup }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚µãƒ¼ãƒ“ã‚¹å­˜åœ¨**: ${{ steps.check-service.outputs.service_exists || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰‹å‹•å®Ÿè¡Œ**: ${{ steps.set-pr.outputs.is_manual }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-conditions.outputs.should_cleanup }}" = "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ã§ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
        fi